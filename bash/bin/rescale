#!/bin/bash
#
# RESCALE - Enlarge text on built-in display


# ──────────────────────────────────────────────────────────
# Detect HiDPI mode

_hidpi(){
	
	test "$(dpi)" -gt 110
	
}


# ──────────────────────────────────────────────────────────
# Update JSON key with value

_json_update(){

	local file
	local key
	local value

	file="$1"
	key="$2"
	value="$3"

	if which jq sponge >/dev/null 2>&1
	then
		jq "$key = $value" "$file" | sponge "$file"
	else
		printf "JQ and SPONGE must be installed.\n" >&2
	fi
	
}


# ──────────────────────────────────────────────────────────
# Scale Unity desktop

_rescale_unity(){

	local text unity
	
	text="/org/gnome/desktop/interface/text-scaling-factor"
	unity="/com/canonical/unity/interface/text-scale-factor"

	if _hidpi
	then
		scale=1.15
	else
		scale=1.0
	fi

	# scale=$(bc -l <<< "sqrt(sqrt( $(dpi) / 96 ))")
	dconf write "$unity" "$scale"
	sleep 0.1
	dconf write "$text" "$scale"

}


# ──────────────────────────────────────────────────────────
# Scale VSCode

_rescale_vscode(){

	local settings
	# local zoom
	# local size

	settings="$HOME/.config/Code/User/settings.json"
	zoom='.["window.zoomLevel"]'
	# size='.["editor.fontSize"]'
	# spacing='.["editor.letterSpacing"]'

	if _hidpi
	then
		_json_update "$settings" "$zoom" "0.3"
		# _json_update "$settings" "$size" "13.5"
		# _json_update "$settings" "$spacing" "-0.6"
	else
		_json_update "$settings" "$zoom" "-0.8"
		# _json_update "$settings" "$size" "14"
		# _json_update "$settings" "$spacing" "-0.7"
	fi

}


# ──────────────────────────────────────────────────────────
# Scale Emacs

_rescale_emacs(){
	
	local font_dc
	local font

	if pgrep emacs >/dev/null 2>&1
	then
		font="SF Mono"
		# font_dc=$(dconf read /org/gnome/desktop/interface/monospace-font-name)
		# font=$(echo "${font_dc//\'/}" | rev | cut -d" " -f2- | rev)
		emacsclient -e "(hrm/dpi/scale-font \"$font\" \"regular\")" >/dev/null
	fi

}


# ──────────────────────────────────────────────────────────
# Main Function

_main(){

	notify-send "rescale" "Scaling text" -t 2500

	_rescale_unity
	_rescale_vscode
	_rescale_emacs

}


# ──────────────────────────────────────────────────────────
# Rescale

_main
