#!/bin/bash

## PATHS

path_to_repos="$HOME/Documents/repos"

## INSTALL PACKAGES

apt_package_installer() {

    notify-send "hrmutils Installer" "Installing APT Packages\n\n"

    if pgrep apt &>/dev/null; then
	sudo pkill apt
	sudo rm -fv /var/lib/apt/lists/lock
	sudo rm -fv /var/cache/apt/archives/lock
	sudo rm -fv /var/lib/dpkg/lock{,-frontend}
    fi
    
    sudo add-apt-repository -y ppa:noobslab/themes
    sudo add-apt-repository -y ppa:noobslab/icons

    sudo apt update
    sudo apt upgrade -y
    
    sudo apt install -y git nautilus-dropbox tmux wmctrl xdotool x11-utils emacs python pass emacs-goodies-el ipython gmrun chromium-browser openconnect locate arc-theme moka-icon-theme arc-icons xfce4-notifyd xfce4-volumed unity-tweak-tool gnome-tweaks dconf-editor

    notify-send "hrmutils Installer" "Installing Snap Packages\n\n"
    
    sudo snap refresh
    sudo snap install remmina google-play-music-desktop-player

}

## CLONE REPOSITORY

path_setup() {

    notify-send "hrmutils Installer" "Creating local directories\n\n"
    emacs_package_path="$HOME/.emacs.d/elpa"
    
    mkdir -p "$emacs_package_path" "$path_to_repos"

}

## INSTALL REPOSITORY FILES

repository_setup() {

    hrmutils_path=$(find / -name hrmutils 2>/dev/null)

    if [[ -z $hrmutils_path ]]; then
	notify-send "hrmutils Installer" "Setting up hrmutils repository\n\n"
	git clone https://github.com/hrmcginnis/hrmutils.git "$path_to_repos"/hrmutils
	bash "$path_to_repos"/hrmutils/install/install_utils
    fi

}

## INSTALL FONTS FROM DROPBOX

font_installer() {

    dropbox_dir="$HOME"/Dropbox
    src_fonts_dir="$HOME"/Dropbox/fonts
    dest_fonts_dir="$HOME"/.local/share/fonts
    begin_while_time=$(date +%s)

    notify-send "hrmutils Installer" "Waiting on fonts from Dropbox"

    while ! which dropbox; do
	sleep 5
    done
    
    # Note: $(dropbox running) returns 1 if dropbox is running.
    #       while loops are active when the condition statement returns 0 (TRUE)
    while dropbox running; do
	sleep 5
    done

    notify-send "hrmutils Installer" "Dropbox successfully installed!"
    dropbox exclude add "$dropbox_dir"/{"books","camera uploads","costa_rica_best_country","interviews","to_sell","windows","work","general documents","phone_stuff","school","docs","office","reformat","resume","code"}
    
    while [[ ! $(dropbox filestatus "$src_fonts_dir") =~ "up to date" ]]; do
	sleep 5
	if (( $(date +%s) - begin_while_time > 3600 )); then
	    notify-send "hrmutils Installer" "Timeout: font_installer timed out while updating Dropbox."
	    exit 1
	fi
    done

    # Install fonts from Dropbox
    mkdir -p "$dest_fonts_dir"
    for dir in $src_fonts_dir/*; do
	cp -rv $dir -t "$dest_fonts_dir"
    done

    fc-cache -fv
    
}

## SET UP DCONF

dconf_settings() {

    interface_schema="org.gnome.desktop.interface"
    wm_schema="org.gnome.desktop.wm.preferences"
    date_schema="com.canonical.indicator.datetime"
    xsettings_schema="org.gnome.settings-daemon.plugins.xsettings"
    unity_schema="org.compiz.unityshell"
    launcher_path="/org/compiz/profiles/unity/plugins/unityshell/"

    sans="FreeSans 10"
    mono="SF Mono 9"
    titlebar="FreeSans Semi-Bold 10"
    theme="Arc-Darker"
    icons="Arc-Icons"
    time_fmt="%A • %d %b %Y • %l:%M %p"
    launcher_size=20
    # launcher_color="#2f343fff"

    gsettings set "$interface_schema" gtk-theme "$theme"
    gsettings set "$interface_schema" icon-theme "$icons"
    gsettings set "$interface_schema" document-font-name "$sans"
    gsettings set "$interface_schema" font-name "$sans"
    gsettings set "$interface_schema" monospace-font-name "$mono"
    gsettings set "$wm_schema" titlebar-font "$titlebar"
    gsettings set "$date_schema" time-format "custom"
    gsettings set "$date_schema" custom-time-format "$time_fmt"
    gsettings set "$xsettings_schema" hinting none
    gsettings set "$unity_schema":"$launcher_path" icon-size "$launcher_size"

    # dconf write "$launcher_path"/background-color "'$launcher_color'"
    # dconf write "$launcher_path"/launcher-minimize-window true
    # dconf write "$launcher_path"/show-hud "'Disabled'"
    
}

## MAIN

main() {

    apt_package_installer
    path_setup
    repository_setup
    font_installer
    
    # sudo apt install -y ubuntu-unity-desktop
    # dconf_settings
    
}

main
