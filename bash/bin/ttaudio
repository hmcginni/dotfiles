#!/bin/bash
#
# TTAUDIO - Connect to (and enable) TaoTronics BH-040 Wireless Headphones
#

source ~/lib/bash/utils
bluetooth on &>/dev/null

timeout=15
ttMAC="E8:AB:FA:23:DA:8F"
agentOn="power on\nagent on\n"
disconnect="disconnect $ttMAC\nuntrust $ttMAC\n"
connect="trust $ttMAC\npair $ttMAC\nconnect $ttMAC\nquit"
btCmd="${agentOn}${disconnect}${connect}"


#
# Send command and wait for successful connection
#

sinks="$(pactl list sinks short)"

if ! grep -q "$(sed -r "s|:|_|g" <<< $ttMAC)" <<< "$sinks"
then
	echo -e "$btCmd" | bluetoothctl &>/dev/null
	sleep 1
	while ! grep -q "bluez" <<< "$sinks"
	do
		sleep 1
		sinks="$(pactl list sinks short)"
		if (( SECONDS >= timeout ))
		then
			errStr=$(printf "%s Exceeded timeout (%d)" "${0--/*/}" "$timeout")
			utils.nerrorf "Error connecting to headphones" "$errStr"
		fi
	done
	utils.notify "Connected to Bluetooth Device" "Connected to TT-BH040"
else
	utils.notify "Connected to Bluetooth Device" "Already connected to TT-BH040"
fi


#
# Set headphones as default output device & enable EQ
#

printf "Connected to %s\n" "$ttMAC"
ttsink=$(awk '/bluez/ {print $2}' <<< "$(pactl list sinks short)")
pactl set-default-sink "$ttsink"
pulseaudio-equalizer enable &>/dev/null


