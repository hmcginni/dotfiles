#!/bin/bash
#
# TTAUDIO - Connect to TaoTronics Wireless Headphones
#

source ~/lib/bash/utils
bluetooth on >/dev/null 2>&1

timeout=15
ttMAC="FC:58:FA:C5:B1:0D"
agent="power on\nagent on\n"
disconnect="disconnect $ttMAC\nuntrust $ttMAC\n"
connect="trust $ttMAC\npair $ttMAC\nconnect $ttMAC\nquit"
btCmd="${agent}${disconnect}${connect}"


# ──────────────────────────────────────────────────────────
# Send command and wait for successful connection
#

sinks="$(pactl list sinks short)"

if ! grep -q "$(sed -r "s|:|_|g" <<< $ttMAC)" <<< "$sinks"
then
	echo -e "$btCmd" | bluetoothctl >/dev/null 2>&1
	sleep 1
	while ! grep -q "bluez" <<< "$sinks"
	do
		sleep 1
		sinks="$(pactl list sinks short)"
		if (( SECONDS >= timeout ))
		then
			errStr=$(printf "%s Exceeded timeout (%d)" "${0--/*/}" "$timeout")
			utils.nerrorf "Error connecting to headphones" "$errStr"
		fi
	done
	utils.notify "Connected to Bluetooth Device" "Connected to headphones"
else
	utils.notify "Connected to Bluetooth Device" "Already connected to headphones"
fi


# ──────────────────────────────────────────────────────────
# Set headphones as default output device & enable EQ
#

printf "Connected to %s\n" "$ttMAC"
ttsink=$(awk '/bluez/ {print $2}' <<< "$(pactl list sinks short)")
pactl set-default-sink "$ttsink"
pulseaudio-equalizer enable >/dev/null 2>&1

